"""
Makes comparisons between our ONCvar data and previous studies.

This module has functions that generate the answers to questions 
like "How many of our variables are previously known (a) stars or
(b) variables?",  "How many of our periodic variables are are newly
determined to be periodic?", "How do our periods compare to previously
published periods?".

These functions operate on the output table generated by orion_tablemate.py 
and tablemate_script.py.

"""

import numpy as np

from tablemate_script import *

# A. How many of our variables are previously known stars?
# B. How many of our variables are previously known variables?
# C. How many of our periodic variables are new period determinations?
# D. How do our periods compare to previously published periods?

# We want to do a couple things. 
# One: for a given subset of literature tables, see how many matches
#   a given source has; and to count how many sources have zero matches. 
#    (In the case of question A, the "given subset" is
#     ALL of the literature tables, plus SIMBAD. For question B, it's
#     tables that identify variables specifically. For question C, it's 
#     tables that identify periodic variables, but since some tables might
#     mix periodic and nonperiodic variables and so I'll need to also access
#     the "period" column contained therein, which requires Two.)
# Two: for input tables, access given columns in those tables corresponding
#   to an input source.


# This is a table I made and then attached 
mated_oncvar = atpy.Table("/home/tom/Dropbox/Bo_Tom/aux_catalogs/matched_table_withSIMBAD_2013_2_25.fits")
oncvar_spread = atpy.Table("/home/tom/Dropbox/Bo_Tom/aux_catalogs/ONCvar_spreadsheet_withSIMBADnames.fits")


# Builds a dict for the source. 
# the length of the dict corresponds 
# The desired table aliases are possible keys, added only if there's 
# a corresponding value in the columns. Value: Possibly a tuple of (name, index).
# Returns two lists: ONCvar ID, above dict. Then you can 
# NO the above is silly. JUST TELL US HOW MANY NON-NULL MATCHES IT HAS AMONG THE GIVEN TABLES.
 



def source_tablematch_counter(table, matches='All'):
    """
    Counts how many times each source has a match.

    Compares the sources in the primary table to the matched tables
    that have already been cross-matched using tablemate_script.

    Parameters
    ----------
    table : atpy.Table
        Output of tablemate_script containing desired sources.
    matches : list of str | 'All', optional
        Which columns of the mated table do we want to scan?
        Default is 'All', i.e. any column that ends in _name, _ID, or _index.
 
    Returns
    -------
    
    """




    # if we don't mess with the default parameter, just scan all the eligible
    # rows straight outta table.columns.keys
    if matches == 'All':

        # we'll be scanning table.columns.keys shortly
        # "eligible" means that the column name is an index or name
        columns_list = [x for x in table.columns.keys if 
                        '_index' in x or '_name' in x]


    # construct a return array that corresponds to the primary ID 
    n_matches = np.zeros(len(table))

    # PSEUDOCODE!
    # for each row [i] in the mated table:
    for i in range(len(table)):
        
    #     for each of the columns we wanna go through:
        for column in columns_list:
    #         if table.column[i] != -1: (OR if '_name' in column, then != '')

            if table[column][i] != -1 and table[column][i] != '':
    #             increment this source's counter by one
                n_matches[i] += 1


        # and if it's a '_name' then a non-match is just an empty string,
        # otherwise '_index'es check for -1


    # Then return a thing that corresponds ONCvar ID to "number of literature matches". Then we can make a histogram or something! And, most importantly, count how many stars in our data are not previously known. Two columns/arrays that correspond to each other.

    return n_matches


def how_many_stars_are_new():
    """
    Figures out how many stars are unknown in any previous catalog.
    
    """
    pass

# This one might be a special case of source_tablematch_counter!
# where we define the input tables as just those that count variables.
def how_many_variables_are_new():
    """
    Figures out how many variables were previously unknown as variables.

    """
    pass
    
def source_period_digger():
    """
    Extracts literature periods, if they exist, for every star.

    """
    pass
